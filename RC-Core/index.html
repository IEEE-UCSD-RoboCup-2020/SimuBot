<!DOCTYPE html>
<html lang="en" >
<head>
    <meta charset="UTF-8">
    <title>Trajectory Viewer</title>
    <link rel="stylesheet" href="./style.css">
</head>
<body>
    <div class="center" style="width:1280px; height:800px;">
    	<div id="y0" style="position:absolute">
    		<img src="img/robot/y0.png">
    	</div>
    	<div id="y1" style="position:absolute">
    		<img src="img/robot/y1.png">
    	</div>
    	<div id="y2" style="position:absolute">
    		<img src="img/robot/y2.png">
    	</div>
    	<div id="y3" style="position:absolute">
    		<img src="img/robot/y3.png">
    	</div>
    	<div id="y4" style="position:absolute">
    		<img src="img/robot/y4.png">
    	</div>
    	<div id="y5" style="position:absolute">
    		<img src="img/robot/y5.png">
    	</div>
    	<div id="b0" style="position:absolute">
    		<img src="img/robot/b0.png">
    	</div>
    	<div id="b1" style="position:absolute">
    		<img src="img/robot/b1.png">
    	</div>
    	<div id="b2" style="position:absolute">
    		<img src="img/robot/b2.png">
    	</div>
    	<div id="b3" style="position:absolute">
    		<img src="img/robot/b3.png">
    	</div>
    	<div id="b4" style="position:absolute">
    		<img src="img/robot/b4.png">
    	</div>
    	<div id="b5" style="position:absolute">
    		<img src="img/robot/b5.png">
    	</div>
		<div id="ball" style="position:absolute">
    		<img src="img/ball.png">
    	</div>
    	<canvas id="canvas" width="1280" height="800"></canvas>
	</div>
	<div class="center">
    	<button id="start" onclick="start()">Start</button>
		<button id="stop" onclick="stop()">Stop</button>
		<button id="clear" onclick="paint_field()">Clear</button>
    </div>

<script>
    var eventSource = null;
    
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const ROBOT_RADIUS = 12;
    
	var geometry = null;
    var last_v = null;
    
  	function update(img, robot) {
  		img.style.left = robot.x;
  		img.style.top  = robot.y;
  		img.style.transform = "rotate(" + robot.o + ")";
  	}

	function paint_ball(img, ball) {
  		img.style.left = ball.x;
  		img.style.top  = ball.y;
	}

	function paint_field() {
		ctx.clearRect(0, 0, 1280, 800);
		ctx.fillStyle = "rgb(35, 72, 35)";
		ctx.fillRect(0, 0, canvas.width, canvas.height);
		Object.keys(geometry.lines).forEach(function(key) {
			ctx.beginPath();
			ctx.strokeStyle = "white";
			line = geometry.lines[key];
			ctx.moveTo(line.x1, line.y1);
			ctx.lineTo(line.x2, line.y2);
			ctx.stroke();
		});
		Object.keys(geometry.arcs).forEach(function(key) {
			ctx.beginPath();
			ctx.strokeStyle = "white";
			arc = geometry.arcs[key]
			ctx.arc(arc.x, arc.y, arc.r, arc.a1, arc.a2);
			ctx.stroke();
		});
	}

	function draw_line(start, end, color) {
		ctx.beginPath();
		ctx.strokeStyle = color;
		ctx.moveTo(parseInt(start.x)+ROBOT_RADIUS, parseInt(start.y)+ROBOT_RADIUS);
		ctx.lineTo(parseInt(end.x)+ROBOT_RADIUS, parseInt(end.y)+ROBOT_RADIUS);
		ctx.stroke();
	}

	function stop() {
		evtSource.close();
	}

    function start() {
    	evtSource = new EventSource('/ViewerServlet');

    	evtSource.addEventListener('message', (e) => {
		    var v = JSON.parse(e.data);

			if (!("y0" in v)) { // Geometry data
				geometry = v;
				paint_field();
				return;
			}

		    update(y0, v.y0);
		    update(y1, v.y1);
		    update(y2, v.y2);
		    update(y3, v.y3);
		    update(y4, v.y4);
		    update(y5, v.y5);
		    update(b0, v.b0);
		    update(b1, v.b1);
		    update(b2, v.b2);
		    update(b3, v.b3);
		    update(b4, v.b4);
		    update(b5, v.b5);
			paint_ball(ball, v.ball);
		    
		    if (last_v !== null) {
				draw_line(last_v.y0, v.y0, "yellow");
				draw_line(last_v.y1, v.y1, "yellow");
				draw_line(last_v.y2, v.y2, "yellow");
				draw_line(last_v.y3, v.y3, "yellow");
				draw_line(last_v.y4, v.y4, "yellow");
				draw_line(last_v.y5, v.y5, "yellow");
				draw_line(last_v.b0, v.b0, "blue");
				draw_line(last_v.b1, v.b1, "blue");
				draw_line(last_v.b2, v.b2, "blue");
				draw_line(last_v.b3, v.b3, "blue");
				draw_line(last_v.b4, v.b4, "blue");
				draw_line(last_v.b5, v.b5, "blue");
		    }
		    last_v = v;
   		});
    }
</script>

</body>
</html>


